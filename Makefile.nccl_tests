SSH_PORT ?= 12345

SNAIL01_FLAGS = --host snail01:2 --mca plm_rsh_args "-p $(SSH_PORT)" -x CUDA_VISIBLE_DEVICES=2,3 -x NCCL_IB_HCA=mlx5_0,mlx5_1
SNAIL02_FLAGS = --host snail02:2 --mca plm_rsh_args "-p $(SSH_PORT)" -x CUDA_VISIBLE_DEVICES=0,1 -x NCCL_IB_HCA=mlx5_1,mlx5_2
SNAIL03_FLAGS = --host snail03:2 --mca plm_rsh_args "-p $(SSH_PORT)" -x CUDA_VISIBLE_DEVICES=0,1 -x NCCL_IB_HCA=mlx5_1,mlx5_2
TVM01_FLAGS   = --host tvm01:2   --mca plm_rsh_args "-p $(SSH_PORT)" -x CUDA_VISIBLE_DEVICES=0,1 -x NCCL_IB_HCA=mlx5_1,mlx5_2
TVM02_FLAGS   = --host tvm02:2   --mca plm_rsh_args "-p $(SSH_PORT)" -x CUDA_VISIBLE_DEVICES=0,1 -x NCCL_IB_HCA=mlx5_1,mlx5_2

DEBUG_FLAG = -x NCCL_DEBUG=INFO
NCCL_TESTS_DIR = 3rd-party/nccl-tests

run:
	mpirun \
	  -n 2 $(SNAIL01_FLAGS) $(DEBUG_FLAG) $(NCCL_TESTS_DIR)/build/reduce_perf \
	: -n 2 $(SNAIL02_FLAGS) $(DEBUG_FLAG) $(NCCL_TESTS_DIR)/build/reduce_perf \
	: -n 2 $(SNAIL03_FLAGS) $(DEBUG_FLAG) $(NCCL_TESTS_DIR)/build/reduce_perf \
	: -n 2 $(TVM01_FLAGS)   $(DEBUG_FLAG) $(NCCL_TESTS_DIR)/build/reduce_perf \
	: -n 2 $(TVM02_FLAGS)   $(DEBUG_FLAG) $(NCCL_TESTS_DIR)/build/reduce_perf \



